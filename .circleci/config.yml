version: 2.1

orbs:
  node: circleci/node@5.2.3
  vercel: circleci/vercel@2.0.0
  gh-pages: peaceiris/actions-gh-pages@4.0.0
  slack: circleci/slack@4.12.5

executors:
  pnpm-executor:
    docker:
      - image: cimg/node:18.19.0
    resource_class: large
    working_directory: ~/project
    environment:
      PNPM_HOME: /home/circleci/.pnpm
      PATH: $PNPM_HOME:$PATH

commands:
  install-deps:
    description: "Install dependencies using pnpm"
    steps:
      - restore_cache:
          keys:
            - pnpm-cache-{{ checksum "pnpm-lock.yaml" }}
            - pnpm-cache-
      - run: corepack enable pnpm
      - run: pnpm install --frozen-lockfile
      - save_cache:
          key: pnpm-cache-{{ checksum "pnpm-lock.yaml" }}
          paths:
            - ~/.pnpm

  run-tests:
    description: "Run tests for a specific app"
    parameters:
      app-dir:
        type: string
    steps:
      - run: cd apps/<< parameters.app-dir >> && pnpm test

  run-lint:
    description: "Run linting for a specific app"
    parameters:
      app-dir:
        type: string
    steps:
      - run: cd apps/<< parameters.app-dir >> && pnpm lint

  run-typecheck:
    description: "Run TypeScript typecheck for a specific app"
    parameters:
      app-dir:
        type: string
    steps:
      - run: cd apps/<< parameters.app-dir >> && pnpm typecheck

  run-fix:
    description: "Auto-fix linting and formatting issues"
    parameters:
      app-dir:
        type: string
    steps:
      - run: cd apps/<< parameters.app-dir >> && pnpm lint:fix && pnpm format

jobs:
  build-and-test-dashboard:
    executor: pnpm-executor
    steps:
      - checkout
      - install-deps
      - run-lint:
          app-dir: dashboard-new
      - run-typecheck:
          app-dir: dashboard-new
      - run-tests:
          app-dir: dashboard-new

  build-and-test-mydispatch:
    executor: pnpm-executor
    steps:
      - checkout
      - install-deps
      - run-tests:
          app-dir: MyDispatch

  build-and-test-opencarbox:
    executor: pnpm-executor
    steps:
      - checkout
      - install-deps
      - run-tests:
          app-dir: OpenCarBox

  security-scan:
    executor: pnpm-executor
    steps:
      - checkout
      - install-deps
      - run:
          name: Run security audit
          command: pnpm audit --audit-level=moderate

  auto-fix:
    executor: pnpm-executor
    steps:
      - checkout
      - install-deps
      - run-fix:
          app-dir: dashboard-new
      - run:
          name: Check for changes after auto-fix
          command: git diff --exit-code || (echo "Changes detected, committing auto-fix" && git add . && git commit -m "Auto-fix: lint and format corrections" && git push)

  docs-deploy:
    executor: pnpm-executor
    steps:
      - checkout
      - install-deps
      - run:
          name: Build docs
          command: pnpm --filter nexify-ai-dashboard build:docs || echo "No docs build script, using README"
      - run:
          name: Deploy docs to GitHub Pages
          command: |
            mkdir -p docs
            cp README.md docs/index.md
            cp MISSION.md docs/
            cp ARCHITECTURE.md docs/ 2>/dev/null || true
            # Add more docs as needed
      - gh-pages/deploy:
          github_token: $GITHUB_TOKEN
          publish_dir: docs

  deploy-dashboard:
    executor: pnpm-executor
    steps:
      - checkout
      - install-deps
      - vercel/deploy:
          api-token: $VERCEL_TOKEN
          working-directory: apps/dashboard-new

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - security-scan
      - build-and-test-dashboard:
          requires:
            - security-scan
      - build-and-test-mydispatch:
          requires:
            - security-scan
      - build-and-test-opencarbox:
          requires:
            - security-scan
      - auto-fix:
          requires:
            - build-and-test-dashboard
          filters:
            branches:
              only:
                - main
                - develop
      - docs-deploy:
          requires:
            - auto-fix
          filters:
            branches:
              only:
                - main
      - deploy-dashboard:
          requires:
            - docs-deploy
          filters:
            branches:
              only:
                - main
                - production
    when: << pipeline.git.branch >> != "dependabot/**"
    jobs:
      - slack/notify:
          event: fail
          template: basic_fail_1
          channel: $SLACK_CHANNEL
          requires:
            - deploy-dashboard
      - slack/notify:
          event: pass
          template: basic_success_1
          channel: $SLACK_CHANNEL
          requires:
            - deploy-dashboard
