stages:
  - validate
  - test
  - build
  - deploy
  - monitor

variables:
  PNPM_VERSION: "9.15.4"
  NODE_VERSION: "18"
  TURBO_TOKEN: ${TURBO_TOKEN}

default:
  image: node:${NODE_VERSION}
  before_script:
    - corepack enable pnpm
    - pnpm install --frozen-lockfile

cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - node_modules/
    - .pnpm-store/

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Secret-Detection.gitlab-ci.yml

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

validate:
  stage: validate
  script:
    - pnpm --filter nexify-ai-dashboard lint
    - pnpm --filter nexify-ai-dashboard typecheck
    - pnpm --filter @nexify/tool-web-search lint
    - pnpm --filter @nexify/tool-memory-bridge lint
    - pnpm --filter @nexify/tool-code-execution lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false
  needs: []

test:dashboard:
  stage: test
  script:
    - pnpm --filter nexify-ai-dashboard test
  coverage: '/All files[^|]*\|[^|]*\s+statements\s+\d+\.\d+%/'
  artifacts:
    reports:
      coverage_report:
        - apps/dashboard-new/coverage/*.json
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  needs: [validate]

test:mydispatch:
  stage: test
  script:
    - cd clients/MyDispatch && pnpm test
  coverage: '/All files[^|]*\|[^|]*\s+statements\s+\d+\.\d+%/'
  artifacts:
    reports:
      coverage_report:
        - clients/MyDispatch/coverage/*.json
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH == "main"
  needs: [validate]

test:opencarbox:
  stage: test
  script:
    - cd clients/OpenCarBox && pnpm test
  coverage: '/All files[^|]*\|[^|]*\s+statements\s+\d+\.\d+%/'
  artifacts:
    reports:
      coverage_report:
        - clients/OpenCarBox/coverage/*.json
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH == "main"
  needs: [validate]

test:e2e:
  stage: test
  script:
    - pnpm --filter nexify-ai-dashboard test:e2e
  artifacts:
    when: always
    paths:
      - apps/dashboard-new/playwright-report/
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  needs: [test:dashboard]

build:dashboard:
  stage: build
  script:
    - pnpm --filter nexify-ai-dashboard build
  artifacts:
    paths:
      - apps/dashboard-new/.next/
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  needs: [test:dashboard]

build:mydispatch:
  stage: build
  script:
    - cd clients/MyDispatch && pnpm build
  artifacts:
    paths:
      - clients/MyDispatch/.next/
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  needs: [test:mydispatch]

build:opencarbox:
  stage: build
  script:
    - cd clients/OpenCarBox && pnpm build
  artifacts:
    paths:
      - clients/OpenCarBox/.next/
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  needs: [test:opencarbox]

deploy:dashboard:preview:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - npm install -g vercel
    - vercel --token=${VERCEL_TOKEN} deploy --prebuilt --yes
  environment:
    name: preview/${CI_COMMIT_REF_SLUG}
    url: https://nexifyai-dashboard.vercel.app
    on_stop: automatic
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  needs: [build:dashboard]

deploy:dashboard:production:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - npm install -g vercel
    - vercel --token=${VERCEL_TOKEN} deploy --prebuilt --prod --yes
  environment:
    name: production
    url: https://nexifyai-dashboard.vercel.app
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  when: manual
  needs: [build:dashboard]

deploy:mydispatch:staging:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - cd clients/MyDispatch && npx netlify-cli deploy --dir=.next --message="Deploy from GitLab"
  environment:
    name: staging
    url: https://mydispatch-staging.netlify.app
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  when: manual
  needs: [build:mydispatch]

deploy:opencarbox:production:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - cd clients/OpenCarBox && npx netlify-cli deploy --dir=.next --prod --message="Deploy from GitLab"
  environment:
    name: production
    url: https://opencarbox.netlify.app
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    when: manual
  needs: [build:opencarbox]

security:sast:
  stage: validate
  script:
    - echo "Running SAST analysis..."
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  needs: []

security:dependency-scan:
  stage: validate
  script:
    - pnpm audit --audit-level=moderate --json > audit-report.json || true
    - echo "Dependency scan completed"
  artifacts:
    reports:
      dependency_scanning:
        - audit-report.json
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  needs: []

monitor:health-check:
  stage: monitor
  script:
    - apk add --no-cache curl
    - curl -f https://nexifyai-dashboard.vercel.app/health || exit 1
    - echo "Health check passed"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  when: on_success
  needs: [deploy:dashboard:production]

auto:fix:
  stage: validate
  script:
    - pnpm --filter nexify-ai-dashboard lint:fix
    - pnpm --filter nexify-ai-dashboard format
    - git diff --exit-code || (git add . && git commit -m "Auto-fix: lint and format corrections" && git push)
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  when: on_failure
  needs: [validate]